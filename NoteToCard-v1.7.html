<!DOCTYPE html>
<html lang="en">

<head>
    <title>NoteToCard</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
</head>
<style type="text/css">
    html {
        width: 100%;
        height: 100%;
    }

    body {
        width: calc(100% - 24px);
        height: calc(100% - 16px);
    }

    #container {
        width: 100%;
        height: 100%;

        display: flex;
        flex-flow: column;
    }

    #block-markdown {
        width: 100%;
        flex: 1;
    }

    input {
        width: 95%;
    }

</style>

<body>
    <div id="container">
        <table id="table">
            <tr>
                <td><label title="NoteToCard Á¨îËÆ∞Âà∂Âç°ÊúçÂä° URL">ÊúçÂä°</label></td>
                <td><input id="ntc-server" type="text" placeholder="http(s)://host:port/path" value="http://106.52.132.84:8080/obsidian"></input></td>
                <td><label title="NoteToCard Âà∂Âç°Á±ªÂûã">Á±ªÂûã</label></td>
                <td>
                    <select id="ntc-handler">
                        <option selected>NoteToCard</option>
                    </select>
                </td>
            </tr>

            <tr>
                <td><label title="NoteToCard Áî®Êà∑ÈÇÆÁÆ±">ÈÇÆÁÆ±</label></td>
                <td><input id="ntc-email" type="text" placeholder=""></input></td>
                <td>
                    <labell title="NoteToCard Áî®Êà∑ÂØÜÁ†Å">ÂØÜÁ†Å</label>
                </td>
                <td><input id="ntc-password" type="password"></input></td>
            </tr>
            <tr>
                <td><label title="Âùó ID / ÂùóË∂ÖÈìæÊé•">ÂùóID</label></td>
                <td><input id="block-id" type="text" placeholder="00000000000000-xxxxxxx"></input></td>
                <td><label title="Âç°ÁâáÊ†áÈ¢ò">Ê†áÈ¢ò</label></td>
                <td><input id="block-title" type="text" placeholder="Âç°ÁâáÊ†áÈ¢ò"></input></td>
            </tr>
            <tr>
                <td><button id="button-open" title="Âú®Êñ∞Á™óÂè£ÊâìÂºÄ">ÊâìÂºÄ</button></td>
                <td>
                    <button id="button-preview" title="È¢ÑËßà markdown Ê∫ê‰ª£Á†Å">È¢ÑËßà</button>
                    <button id="button-convert" title="Êèê‰∫§ markdown Ê∫ê‰ª£Á†ÅËá≥ NoteToCard ÊúçÂä°Âô®‰ª•Âà∂Âç°" disabled>Âà∂Âç°</button>
                </td>
            </tr>
        </table>
        <textarea id="block-markdown" placeholder="<markdown Ê∫ê‰ª£Á†Å>"></textarea>
    </div>
</body>

<script type="text/javascript">
    (async () => {
        const ntc_server = document.getElementById('ntc-server')
        const ntc_handler = document.getElementById('ntc-handler')
        const ntc_email = document.getElementById('ntc-email')
        const ntc_password = document.getElementById('ntc-password')

        const block_id = document.getElementById('block-id')
        const block_title = document.getElementById('block-title')
        const block_markdown = document.getElementById('block-markdown')

        const button_open = document.getElementById('button-open')
        const button_preview = document.getElementById('button-preview')
        const button_convert = document.getElementById('button-convert')

        const url = new URL(window.location.href);
        let local_config = JSON.parse(window.localStorage.getItem('NoteToCard'));
        const config = {
            server: (local_config && local_config.server) || ntc_server.value,
            handler: (local_config && local_config.handler) || ntc_handler.value,
            email: (local_config && local_config.email) || ntc_email.value,
            password: (local_config && local_config.password) || ntc_password.value,
            blockId: block_id.value,
            title: block_title.value,
            markdown: block_markdown.value
        };
        // console.log(config);

        /* üëáÊÄùÊ∫ê API ËØ∑Ê±ÇÊñπÊ≥ïüëá */
        /* siyuan ËØ∑Ê±Ç */
        async function siyuanRequest(url, data, token) {
            let response = await fetch(
                url,
                {
                    method: "POST",
                    headers: {
                        Authorization: `Token ${token}`,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data),
                },
            );
            if (response.status === 200) response = await response.json();
            else return null;
            if (response.code === 0) return response.data;
            else return null;
        }

        /* Ëé∑ÂèñÂùóÂ±ûÊÄß */
        async function getBlockAttrs(id, token = null) {
            return siyuanRequest('/api/attr/getBlockAttrs', { id: id }, token);
        }

        /* ËÆæÁΩÆÂùóÂ±ûÊÄß */
        async function setBlockAttrs(id, attrs, token = null) {
            return siyuanRequest('/api/attr/setBlockAttrs', { id: id, attrs: attrs }, token);
        }

        /* Êü•ËØ¢Âùó */
        async function queryBlock(id, token = null) {
            return siyuanRequest(
                '/api/query/sql',
                { stmt: `SELECT * FROM blocks WHERE id = '${id}'` },
                token,
            );
        }

        /* ÂØºÂá∫ÊñáÊ°£ Markdown */
        async function exportMdContent(id, token = null) {
            return siyuanRequest('/api/export/exportMdContent', { id: id }, token);
        }

        /* Êé®ÈÄÅÊ∂àÊÅØ */
        async function pushMsg(msg, timeout = 7000, token = null) {
            return siyuanRequest('/api/notification/pushMsg', {
                msg: msg,
                timeout: timeout,
            }, token);
        }

        /* Êé®ÈÄÅÈîôËØØÊ∂àÊÅØ */
        async function pushErrMsg(msg, timeout = 7000, token = null) {
            return siyuanRequest('/api/notification/pushErrMsg', {
                msg: msg,
                timeout: timeout,
            }, token);
        }
        /* üëÜÊÄùÊ∫ê API ËØ∑Ê±ÇÊñπÊ≥ïüëÜ */

        /* üëáNoteToCard API ËØ∑Ê±ÇÊñπÊ≥ïüëá */
        async function ntcRequest(url, filename, md, email, password, handler) {
            let response = await fetch(
                url,
                {
                    method: "POST",
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        filename: filename,
                        md: md,
                        email: email,
                        password: password,
                        handler: handler,
                    }),
                },
            );
            return await response.json();
        }
        /* üëÜNoteToCard API ËØ∑Ê±ÇÊñπÊ≥ïüëÜ */

        /* üëáÂú®Êñ∞Á™óÂè£ÊâìÂºÄüëá */
        /**
         * Êñ∞Á™óÂè£ÊâìÂºÄ
         * REF https://github.com/Zuoqiu-Yingyi/siyuan-theme-dark-plus/blob/54a6342d711cd5ac31457a830af94d1d39edbdc5/script/module/html.js#L62-L187
         * @url (string): URL
         * @urlParams (object): URL ÂèÇÊï∞
         * @windowParams (object): Á™ó‰ΩìÂèÇÊï∞
         * @menuTemplate (object): Á™óÂè£ËèúÂçïÊ†èÊ®°Êùø
         * @return (BrowserWindow): Á™óÂè£ÂØπË±°
         */
        function openNewWindow(
            url = window.location.href,
            urlParams = {},
            windowParams = {
                width: 720,
                height: 480,
                frame: true, // ÊòØÂê¶ÊòæÁ§∫ËæπÁºòÊ°Ü
                fullscreen: false, // ÊòØÂê¶ÂÖ®Â±èÊòæÁ§∫
                alwaysOnTop: true, // ÊòØÂê¶ÁΩÆÈ°∂ÊòæÁ§∫
                autoHideMenuBar: false, // ÊòØÂê¶ÈöêËóèËèúÂçïÊ†è(‰ΩøÁî® Alt ÊòæÁ§∫)
            },
            menuTemplate = [
                // Êñ∞Á™óÂè£ËèúÂçïÊ®°Êùø
                // REF [ËèúÂçïÈ°π | Electron](https://www.electronjs.org/zh/docs/latest/api/menu-item)
                {
                    label: 'SiYuan',
                    submenu: [
                        {
                            label: 'About SiYuan',
                            role: 'about',
                        },
                        { type: 'separator' },
                        { role: 'services' },
                        { type: 'separator' },
                        {
                            label: 'Hide SiYuan',
                            role: 'hide',
                        },
                        { role: 'hideOthers' },
                        { role: 'unhide' },
                        { type: 'separator' },
                        {
                            label: 'Quit SiYuan',
                            role: 'quit',
                        },
                    ],
                },
                {
                    role: 'editMenu',
                    submenu: [
                        { role: 'selectAll' },
                        { role: 'cut' },
                        { role: 'copy' },
                        { role: 'paste' },
                        { role: 'pasteAndMatchStyle', accelerator: 'CmdOrCtrl+Shift+V' },
                        { type: 'separator' },
                        { role: 'toggleSpellChecker' },
                    ],
                },
                {
                    role: 'viewMenu',
                    submenu: [
                        { role: 'resetZoom' },
                        { role: 'zoomIn', accelerator: 'CmdOrCtrl+=' },
                        { role: 'zoomOut' },
                    ],
                },
                {
                    role: 'windowMenu',
                    submenu: [
                        { role: 'minimize' },
                        { role: 'zoom' },
                        { role: 'togglefullscreen' },
                        { type: 'separator' },
                        { role: 'toggledevtools' },
                        { type: 'separator' },
                        { role: 'front' },
                        { type: 'separator' },
                        { role: 'reload', accelerator: 'F5' },
                        { role: 'forcereload', accelerator: 'CmdOrCtrl+F5' },
                        { role: 'close' },
                        { type: 'separator' },
                        {
                            label: 'Pinned',
                            click: (menuItem, browserWindow, event) => {
                                if (browserWindow) browserWindow.setAlwaysOnTop(!browserWindow.isAlwaysOnTop());
                            },
                            type: 'checkbox',
                            checked: true,
                            // REF [Âø´Êç∑ÈîÆ | Electron](https://www.electronjs.org/zh/docs/latest/api/accelerator)
                            accelerator: 'Alt+Shift+P',
                        },
                    ],
                },
            ],
        ) {
            try {
                url = new URL(url);
                // ËÆæÁΩÆ URL ÂèÇÊï∞
                for (const param in urlParams) {
                    url.searchParams.set(param, urlParams[param]);
                }
                // ÊâìÂºÄÊñ∞Á™óÂè£
                try {
                    const {
                        BrowserWindow,
                        Menu,
                    } = window.top.require('@electron/remote');
                    // Êñ∞Âª∫Á™óÂè£(Electron ÁéØÂ¢É)
                    var newWin = new BrowserWindow(windowParams);
                    const menu = Menu.buildFromTemplate(menuTemplate);

                    // console.log(menu);
                    console.log(url.href);

                    // if (url.protocol === 'file:') newWin.loadFile(url.href.substr(8));
                    // else newWin.loadURL(url.href);
                    newWin.setMenu(menu);
                    newWin.loadURL(url.href);
                    // REF [Event: 'console-message'‚Äã](https://www.electronjs.org/docs/latest/api/web-contents#event-console-message)
                    newWin.on('closed', () => {
                        newWin = null;
                    })
                    return newWin;
                }
                catch (err) {
                    console.warn(err);
                    // Êñ∞Âª∫Ê†áÁ≠æÈ°µ(Web ÁéØÂ¢É)
                    // window.open(url.href, "_blank");
                    window.open(url.href, "popup");
                    return null;
                }
            }
            catch (err) {
                console.error(err);
                return null;
            }
        }
        /* üëÜÂú®Êñ∞Á™óÂè£ÊâìÂºÄüëÜ */

        /* üëá‰∫ã‰ª∂Â§ÑÁêÜÊñπÊ≥ïüëá */
        /* ‰øùÂ≠òÈÖçÁΩÆ */
        async function saveConfig() {
            config.server = ntc_server.value;
            config.handler = ntc_handler.value;
            config.email = ntc_email.value;
            config.password = ntc_password.value;

            const attrs = {
                'custom-ntc-server': config.server,
                'custom-ntc-handler': config.handler,
                'custom-ntc-email': config.email,
                'custom-ntc-password': config.password,
            };

            window.localStorage.setItem(
                'NoteToCard',
                JSON.stringify({
                    server: config.server,
                    handler: config.handler,
                    email: config.email,
                    password: config.password,
                }),
            );
            await setBlockAttrs(widget_id, attrs);
        }

        /* üëÜ‰∫ã‰ª∂Â§ÑÁêÜÊñπÊ≥ïüëÜ */


        /* Ëé∑Âèñ‰øùÂ≠òÂú®ÊåÇ‰ª∂ÂùóÂ±ûÊÄß‰∏≠ÁöÑÈÖçÁΩÆ */
        var widget_id = url.searchParams.get('id');

        if (widget_id == null) {
            let node = window.frameElement != null ? window.frameElement.parentElement.parentElement : null;
            if (node != null) widget_id = node.getAttribute('data-node-id');
        }
        if (widget_id) { // Âä†ËΩΩ‰øùÂ≠òÂú®ÊåÇ‰ª∂ÂùóÂ±ûÊÄß‰∏≠ÁöÑÈÖçÁΩÆ
            const attrs = await getBlockAttrs(widget_id);
            /* ‰ΩøÁî®ÊåÇ‰ª∂ÂùóÂ±ûÊÄß‰∏≠ÁöÑÂÜÖÂÆπË¶ÜÁõñÈªòËÆ§ÈÖçÁΩÆ */
            if (attrs) {
                config.server = attrs['custom-ntc-server'] || config.server;
                config.handler = attrs['custom-ntc-handler'] || config.handler;
                config.email = attrs['custom-ntc-email'] || config.email;
                config.password = attrs['custom-ntc-password'] || config.password;

                ntc_server.value = config.server;
                ntc_handler.value = config.handler;
                ntc_email.value = config.email;
                ntc_password.value = config.password;
            }
            /* ÁõëÂê¨ input ÂÖÉÁ¥†, Âú®Â§±ÂéªÁÑ¶ÁÇπÊó∂‰øùÂ≠ò */
            ntc_server.onblur = saveConfig;
            ntc_handler.onblur = saveConfig;
            ntc_email.onblur = saveConfig;
            ntc_password.onblur = saveConfig;
        }

        /* ÁõëÂê¨ÊâìÂºÄÊåâÈíÆÂçïÂáª‰∫ã‰ª∂ */
        button_open.onclick = () => openNewWindow(url.href, { id: widget_id });

        /* ÁõëÂê¨È¢ÑËßàÊåâÈíÆÂçïÂáª‰∫ã‰ª∂ */
        button_preview.onclick = async () => {
            let id = block_id.value;
            /* Âà§Êñ≠ ID ÊòØÂê¶ÂêàÊ≥ï(‰∏çÂêàÊ≥ïÊ∂àÊÅØÊèêÁ§∫) */
            switch (true) {
                case /^\d{14}\-[0-9a-z]{7}$/.test(id):
                    break;
                case /^siyuan:\/\/blocks\/(\d{14}\-[0-9a-z]{7})\/*(?:(?:\?)(\w+=\w+)(?:(?:\&)(\w+=\w+))*)?$/.test(id):
                    id = id.match(/^siyuan:\/\/blocks\/(\d{14}\-[0-9a-z]{7})\/*(?:(?:\?)(\w+=\w+)(?:(?:\&)(\w+=\w+))*)?$/)[1];
                    break;
                default:
                    id = null;
            }
            if (id) {
                let block = await queryBlock(id);
                if (block && block.length == 1) {
                    block = block[0];
                    /* Âà§Êñ≠ ID ÊòØÊñáÊ°£ ID ËøòÊòØÂùó ID */
                    switch (block.type) {
                        case 'd': // ÊñáÊ°£Âùó
                            const doc = await exportMdContent(id);
                            if (doc) {
                                config.title = block.content;
                                config.markdown = doc.content;
                            }
                            else {
                                await pushErrMsg(`NoteToCard: ID=${id} ÁöÑÊñáÊ°£ÂØºÂá∫ markdown Â§±Ë¥•`);
                                return null;
                            }
                            break;
                        default:
                            config.title = block.name
                                || block.alias
                                || block.memo
                                || block.fcontent
                                || block.content;
                            config.markdown = block.markdown;
                            break;
                    }
                }
                else {
                    await pushErrMsg(`NoteToCard: ID=${id} ÁöÑÂùó‰∏çÂ≠òÂú®`);
                    return null;
                }
                /* Ëé∑ÂæóÂØπÂ∫îÂùóÊ†áÈ¢òÂπ∂ÊòæÁ§∫ */
                block_title.value = config.title;
                /* Ëé∑ÂæóÂØπÂ∫îÂùó Markdown Ê∫ê‰ª£Á†ÅÂπ∂ÂÜôÂÖ• textarea */
                block_markdown.value = config.markdown;
            }
            else {
                await pushErrMsg(`NoteToCard: Âùó ID Ê†ºÂºèÈîôËØØ`);
                return null;
            }
            button_convert.disabled = false;
        };

        /* ÁõëÂê¨ËΩ¨Êç¢ÊåâÈíÆÂçïÂáª‰∫ã‰ª∂ */
        button_convert.onclick = async () => {
            config.server = ntc_server.value;
            config.title = block_title.value;
            config.markdown = block_markdown.value;
            config.email = ntc_email.value;
            config.password = ntc_password.value;
            config.handler = ntc_handler.value;

            /* Âà§Êñ≠Â≠óÊÆµÊòØÂê¶Â°´ÂÜôÂÆåÊï¥ */
            if (config.server
                && config.title
                && config.markdown
                && config.email
                && config.password
                && config.handler
            ) {
                /* ÂèëÈÄÅËØ∑Ê±Ç */
                const response = await ntcRequest(
                    config.server,
                    config.title,
                    config.markdown,
                    config.email,
                    config.password,
                    config.handler,
                );
                /* Âà§Êñ≠ÊòØÂê¶ÂèëÈÄÅÊàêÂäü, Êé®ÈÄÅÊ∂àÊÅØÊèêÁ§∫ */
                if (response.status === true || response.status >= 200 && response.status < 300) {
                    await pushMsg(`NoteToCard: ${response.msg}`);
                    return null;
                }
                else {
                    await pushErrMsg(`NoteToCard: ${response.error || response.msg}`);
                    return null;
                }
            }
            else {
                switch ('') {
                    case config.server:
                        await pushErrMsg(`NoteToCard: ÊúçÂä° Â≠óÊÆµ‰∏∫Á©∫`);
                        break;
                    case config.title:
                        await pushErrMsg(`NoteToCard: Ê†áÈ¢ò Â≠óÊÆµ‰∏∫Á©∫`);
                        break;
                    case config.markdown:
                        await pushErrMsg(`NoteToCard: markdown Â≠óÊÆµ‰∏∫Á©∫`);
                        break;
                    case config.email:
                        await pushErrMsg(`NoteToCard: ÈÇÆÁÆ± Â≠óÊÆµ‰∏∫Á©∫`);
                        break;
                    case config.password:
                        await pushErrMsg(`NoteToCard: ÂØÜÁ†Å Â≠óÊÆµ‰∏∫Á©∫`);
                        break;
                    case config.handler:
                        await pushErrMsg(`NoteToCard: ÊñπÊ≥ï Â≠óÊÆµ‰∏∫Á©∫`);
                        break;
                }
                return;
            }
        }

        /* ÁõëÂê¨ markdown È¢ÑËßàÊñáÊú¨Ê°ÜÂÜÖÂÆπÊõ¥Êîπ */
        block_markdown.onchange = () => {
            if (block_markdown.value) {
                button_convert.disabled = false;
            }
            else {
                button_convert.disabled = true;
            }
        }
    })();
</script>

</html>
