<!DOCTYPE html>
<html lang="en">

<head>
    <title>NoteToCard</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
</head>
<style type="text/css">
    html {
        width: 100%;
        height: 100%;
    }

    body {
        width: calc(100% - 24px);
        height: calc(100% - 16px);
    }

    #container {
        width: 100%;
        height: 100%;

        display: flex;
        flex-flow: column;
    }

    #block-markdown {
        width: 100%;
        flex: 1;
    }

    input {
        width: 95%;
    }

</style>

<body>
    <div id="container">
        <table id="table">
            <tr>
                <td><label title="NoteToCard ç¬”è®°åˆ¶å¡æœåŠ¡ URL">æœåŠ¡</label></td>
                <td><input id="ntc-server" type="text" placeholder="http(s)://host:port/path" value="https://notetocard.com/obsidian"></input></td>
                <td><label title="NoteToCard åˆ¶å¡ç±»å‹">ç±»å‹</label></td>
                <td>
                    <select id="ntc-handler">
                        <option selected>NoteToCard</option>
                        <option selected>æ‰¹é‡å¡</option>
                        <option selected>Smææ–™å¯¼å…¥</option>
                        <option selected>Mdâ‡„Opml</option>
                    </select>
                </td>
            </tr>

            <tr>
                <td><label title="NoteToCard ç”¨æˆ·é‚®ç®±">é‚®ç®±</label></td>
                <td><input id="ntc-email" type="text" placeholder=""></input></td>
                <td>
                    <labell title="NoteToCard ç”¨æˆ·å¯†ç ">å¯†ç </label>
                </td>
                <td><input id="ntc-password" type="password"></input></td>
            </tr>
            <tr>
                <td><label title="å— ID / å—è¶…é“¾æ¥">å—ID</label></td>
                <td><input id="block-id" type="text" placeholder="00000000000000-xxxxxxx"></input></td>
                <td><label title="å¡ç‰‡æ ‡é¢˜">æ ‡é¢˜</label></td>
                <td><input id="block-title" type="text" placeholder="å¡ç‰‡æ ‡é¢˜"></input></td>
            </tr>
            <tr>
                <td><button id="button-open" title="åœ¨æ–°çª—å£æ‰“å¼€">æ‰“å¼€</button></td>
                <td>
                    <button id="button-preview" title="é¢„è§ˆ markdown æºä»£ç ">é¢„è§ˆ</button>
                    <button id="button-convert" title="æäº¤ markdown æºä»£ç è‡³ NoteToCard æœåŠ¡å™¨ä»¥åˆ¶å¡" disabled>åˆ¶å¡</button>
                </td>
            </tr>
        </table>
        <textarea id="block-markdown" placeholder="<markdown æºä»£ç >"></textarea>
    </div>
</body>

<script type="text/javascript">
    (async () => {
        const ntc_server = document.getElementById('ntc-server')
        const ntc_handler = document.getElementById('ntc-handler')
        const ntc_email = document.getElementById('ntc-email')
        const ntc_password = document.getElementById('ntc-password')

        const block_id = document.getElementById('block-id')
        const block_title = document.getElementById('block-title')
        const block_markdown = document.getElementById('block-markdown')

        const button_open = document.getElementById('button-open')
        const button_preview = document.getElementById('button-preview')
        const button_convert = document.getElementById('button-convert')

        const url = new URL(window.location.href);
        let local_config = JSON.parse(window.localStorage.getItem('NoteToCard'));
        const config = {
            server: (local_config && local_config.server) || ntc_server.value,
            handler: (local_config && local_config.handler) || ntc_handler.value,
            email: (local_config && local_config.email) || ntc_email.value,
            password: (local_config && local_config.password) || ntc_password.value,
            blockId: block_id.value,
            title: block_title.value,
            markdown: block_markdown.value
        };
        // console.log(config);

        /* ğŸ‘‡æ€æº API è¯·æ±‚æ–¹æ³•ğŸ‘‡ */
        /* siyuan è¯·æ±‚ */
        async function siyuanRequest(url, data, token) {
            let response = await fetch(
                url,
                {
                    method: "POST",
                    headers: {
                        Authorization: `Token ${token}`,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data),
                },
            );
            if (response.status === 200) response = await response.json();
            else return null;
            if (response.code === 0) return response.data;
            else return null;
        }

        /* è·å–å—å±æ€§ */
        async function getBlockAttrs(id, token = null) {
            return siyuanRequest('/api/attr/getBlockAttrs', { id: id }, token);
        }

        /* è®¾ç½®å—å±æ€§ */
        async function setBlockAttrs(id, attrs, token = null) {
            return siyuanRequest('/api/attr/setBlockAttrs', { id: id, attrs: attrs }, token);
        }

        /* æŸ¥è¯¢å— */
        async function queryBlock(id, token = null) {
            return siyuanRequest(
                '/api/query/sql',
                { stmt: `SELECT * FROM blocks WHERE id = '${id}'` },
                token,
            );
        }

        /* å¯¼å‡ºæ–‡æ¡£ Markdown */
        async function exportMdContent(id, token = null) {
            return siyuanRequest('/api/export/exportMdContent', { id: id }, token);
        }

        /* æ¨é€æ¶ˆæ¯ */
        async function pushMsg(msg, timeout = 7000, token = null) {
            return siyuanRequest('/api/notification/pushMsg', {
                msg: msg,
                timeout: timeout,
            }, token);
        }

        /* æ¨é€é”™è¯¯æ¶ˆæ¯ */
        async function pushErrMsg(msg, timeout = 7000, token = null) {
            return siyuanRequest('/api/notification/pushErrMsg', {
                msg: msg,
                timeout: timeout,
            }, token);
        }
        /* ğŸ‘†æ€æº API è¯·æ±‚æ–¹æ³•ğŸ‘† */

        /* ğŸ‘‡NoteToCard API è¯·æ±‚æ–¹æ³•ğŸ‘‡ */
        async function ntcRequest(url, filename, md, email, password, handler) {
            let response = await fetch(
                url,
                {
                    method: "POST",
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        filename: filename,
                        md: md,
                        email: email,
                        password: password,
                        handler: handler,
                    }),
                },
            );
            return await response.json();
        }
        /* ğŸ‘†NoteToCard API è¯·æ±‚æ–¹æ³•ğŸ‘† */

        /* ğŸ‘‡åœ¨æ–°çª—å£æ‰“å¼€ğŸ‘‡ */
        /**
         * æ–°çª—å£æ‰“å¼€
         * REF https://github.com/Zuoqiu-Yingyi/siyuan-theme-dark-plus/blob/54a6342d711cd5ac31457a830af94d1d39edbdc5/script/module/html.js#L62-L187
         * @url (string): URL
         * @urlParams (object): URL å‚æ•°
         * @windowParams (object): çª—ä½“å‚æ•°
         * @menuTemplate (object): çª—å£èœå•æ æ¨¡æ¿
         * @return (BrowserWindow): çª—å£å¯¹è±¡
         */
        function openNewWindow(
            url = window.location.href,
            urlParams = {},
            windowParams = {
                width: 720,
                height: 480,
                frame: true, // æ˜¯å¦æ˜¾ç¤ºè¾¹ç¼˜æ¡†
                fullscreen: false, // æ˜¯å¦å…¨å±æ˜¾ç¤º
                alwaysOnTop: true, // æ˜¯å¦ç½®é¡¶æ˜¾ç¤º
                autoHideMenuBar: false, // æ˜¯å¦éšè—èœå•æ (ä½¿ç”¨ Alt æ˜¾ç¤º)
            },
            menuTemplate = [
                // æ–°çª—å£èœå•æ¨¡æ¿
                // REF [èœå•é¡¹ | Electron](https://www.electronjs.org/zh/docs/latest/api/menu-item)
                {
                    label: 'SiYuan',
                    submenu: [
                        {
                            label: 'About SiYuan',
                            role: 'about',
                        },
                        { type: 'separator' },
                        { role: 'services' },
                        { type: 'separator' },
                        {
                            label: 'Hide SiYuan',
                            role: 'hide',
                        },
                        { role: 'hideOthers' },
                        { role: 'unhide' },
                        { type: 'separator' },
                        {
                            label: 'Quit SiYuan',
                            role: 'quit',
                        },
                    ],
                },
                {
                    role: 'editMenu',
                    submenu: [
                        { role: 'selectAll' },
                        { role: 'cut' },
                        { role: 'copy' },
                        { role: 'paste' },
                        { role: 'pasteAndMatchStyle', accelerator: 'CmdOrCtrl+Shift+V' },
                        { type: 'separator' },
                        { role: 'toggleSpellChecker' },
                    ],
                },
                {
                    role: 'viewMenu',
                    submenu: [
                        { role: 'resetZoom' },
                        { role: 'zoomIn', accelerator: 'CmdOrCtrl+=' },
                        { role: 'zoomOut' },
                    ],
                },
                {
                    role: 'windowMenu',
                    submenu: [
                        { role: 'minimize' },
                        { role: 'zoom' },
                        { role: 'togglefullscreen' },
                        { type: 'separator' },
                        { role: 'toggledevtools' },
                        { type: 'separator' },
                        { role: 'front' },
                        { type: 'separator' },
                        { role: 'reload', accelerator: 'F5' },
                        { role: 'forcereload', accelerator: 'CmdOrCtrl+F5' },
                        { role: 'close' },
                        { type: 'separator' },
                        {
                            label: 'Pinned',
                            click: (menuItem, browserWindow, event) => {
                                if (browserWindow) browserWindow.setAlwaysOnTop(!browserWindow.isAlwaysOnTop());
                            },
                            type: 'checkbox',
                            checked: true,
                            // REF [å¿«æ·é”® | Electron](https://www.electronjs.org/zh/docs/latest/api/accelerator)
                            accelerator: 'Alt+Shift+P',
                        },
                    ],
                },
            ],
        ) {
            try {
                url = new URL(url);
                // è®¾ç½® URL å‚æ•°
                for (const param in urlParams) {
                    url.searchParams.set(param, urlParams[param]);
                }
                // æ‰“å¼€æ–°çª—å£
                try {
                    const {
                        BrowserWindow,
                        Menu,
                    } = window.top.require('@electron/remote');
                    // æ–°å»ºçª—å£(Electron ç¯å¢ƒ)
                    var newWin = new BrowserWindow(windowParams);
                    const menu = Menu.buildFromTemplate(menuTemplate);

                    // console.log(menu);
                    console.log(url.href);

                    // if (url.protocol === 'file:') newWin.loadFile(url.href.substr(8));
                    // else newWin.loadURL(url.href);
                    newWin.setMenu(menu);
                    newWin.loadURL(url.href);
                    // REF [Event: 'console-message'â€‹](https://www.electronjs.org/docs/latest/api/web-contents#event-console-message)
                    newWin.on('closed', () => {
                        newWin = null;
                    })
                    return newWin;
                }
                catch (err) {
                    console.warn(err);
                    // æ–°å»ºæ ‡ç­¾é¡µ(Web ç¯å¢ƒ)
                    // window.open(url.href, "_blank");
                    window.open(url.href, "popup");
                    return null;
                }
            }
            catch (err) {
                console.error(err);
                return null;
            }
        }
        /* ğŸ‘†åœ¨æ–°çª—å£æ‰“å¼€ğŸ‘† */

        /* ğŸ‘‡äº‹ä»¶å¤„ç†æ–¹æ³•ğŸ‘‡ */
        /* ä¿å­˜é…ç½® */
        async function saveConfig() {
            config.server = ntc_server.value;
            config.handler = ntc_handler.value;
            config.email = ntc_email.value;
            config.password = ntc_password.value;

            const attrs = {
                'custom-ntc-server': config.server,
                'custom-ntc-handler': config.handler,
                'custom-ntc-email': config.email,
                'custom-ntc-password': config.password,
            };

            window.localStorage.setItem(
                'NoteToCard',
                JSON.stringify({
                    server: config.server,
                    handler: config.handler,
                    email: config.email,
                    password: config.password,
                }),
            );
            await setBlockAttrs(widget_id, attrs);
        }

        /* ğŸ‘†äº‹ä»¶å¤„ç†æ–¹æ³•ğŸ‘† */


        /* è·å–ä¿å­˜åœ¨æŒ‚ä»¶å—å±æ€§ä¸­çš„é…ç½® */
        var widget_id = url.searchParams.get('id');

        if (widget_id == null) {
            let node = window.frameElement != null ? window.frameElement.parentElement.parentElement : null;
            if (node != null) widget_id = node.getAttribute('data-node-id');
        }
        if (widget_id) { // åŠ è½½ä¿å­˜åœ¨æŒ‚ä»¶å—å±æ€§ä¸­çš„é…ç½®
            const attrs = await getBlockAttrs(widget_id);
            /* ä½¿ç”¨æŒ‚ä»¶å—å±æ€§ä¸­çš„å†…å®¹è¦†ç›–é»˜è®¤é…ç½® */
            if (attrs) {
                config.server = attrs['custom-ntc-server'] || config.server;
                config.handler = attrs['custom-ntc-handler'] || config.handler;
                config.email = attrs['custom-ntc-email'] || config.email;
                config.password = attrs['custom-ntc-password'] || config.password;

                ntc_server.value = config.server;
                ntc_handler.value = config.handler;
                ntc_email.value = config.email;
                ntc_password.value = config.password;
            }
            /* ç›‘å¬ input å…ƒç´ , åœ¨å¤±å»ç„¦ç‚¹æ—¶ä¿å­˜ */
            ntc_server.onblur = saveConfig;
            ntc_handler.onblur = saveConfig;
            ntc_email.onblur = saveConfig;
            ntc_password.onblur = saveConfig;
        }

        /* ç›‘å¬æ‰“å¼€æŒ‰é’®å•å‡»äº‹ä»¶ */
        button_open.onclick = () => openNewWindow(url.href, { id: widget_id });

        /* ç›‘å¬é¢„è§ˆæŒ‰é’®å•å‡»äº‹ä»¶ */
        button_preview.onclick = async () => {
            let id = block_id.value;
            /* åˆ¤æ–­ ID æ˜¯å¦åˆæ³•(ä¸åˆæ³•æ¶ˆæ¯æç¤º) */
            switch (true) {
                case /^\d{14}\-[0-9a-z]{7}$/.test(id):
                    break;
                case /^siyuan:\/\/blocks\/(\d{14}\-[0-9a-z]{7})\/*(?:(?:\?)(\w+=\w+)(?:(?:\&)(\w+=\w+))*)?$/.test(id):
                    id = id.match(/^siyuan:\/\/blocks\/(\d{14}\-[0-9a-z]{7})\/*(?:(?:\?)(\w+=\w+)(?:(?:\&)(\w+=\w+))*)?$/)[1];
                    break;
                default:
                    id = null;
            }
            if (id) {
                let block = await queryBlock(id);
                if (block && block.length == 1) {
                    block = block[0];
                    /* åˆ¤æ–­ ID æ˜¯æ–‡æ¡£ ID è¿˜æ˜¯å— ID */
                    switch (block.type) {
                        case 'd': // æ–‡æ¡£å—
                            const doc = await exportMdContent(id);
                            if (doc) {
                                config.title = block.content;
                                config.markdown = doc.content;
                            }
                            else {
                                await pushErrMsg(`NoteToCard: ID=${id} çš„æ–‡æ¡£å¯¼å‡º markdown å¤±è´¥`);
                                return null;
                            }
                            break;
                        default:
                            config.title = block.name
                                || block.alias
                                || block.memo
                                || block.fcontent
                                || block.content;
                            config.markdown = block.markdown;
                            break;
                    }
                }
                else {
                    await pushErrMsg(`NoteToCard: ID=${id} çš„å—ä¸å­˜åœ¨`);
                    return null;
                }
                /* è·å¾—å¯¹åº”å—æ ‡é¢˜å¹¶æ˜¾ç¤º */
                block_title.value = config.title;
                /* è·å¾—å¯¹åº”å— Markdown æºä»£ç å¹¶å†™å…¥ textarea */
                block_markdown.value = config.markdown;
            }
            else {
                await pushErrMsg(`NoteToCard: å— ID æ ¼å¼é”™è¯¯`);
                return null;
            }
            button_convert.disabled = false;
        };

        /* ç›‘å¬è½¬æ¢æŒ‰é’®å•å‡»äº‹ä»¶ */
        button_convert.onclick = async () => {
            config.server = ntc_server.value;
            config.title = block_title.value;
            config.markdown = block_markdown.value;
            config.email = ntc_email.value;
            config.password = ntc_password.value;
            config.handler = ntc_handler.value;

            /* åˆ¤æ–­å­—æ®µæ˜¯å¦å¡«å†™å®Œæ•´ */
            if (config.server
                && config.title
                && config.markdown
                && config.email
                && config.password
                && config.handler
            ) {
                /* å‘é€è¯·æ±‚ */
                const response = await ntcRequest(
                    config.server,
                    config.title,
                    config.markdown,
                    config.email,
                    config.password,
                    config.handler,
                );
                /* åˆ¤æ–­æ˜¯å¦å‘é€æˆåŠŸ, æ¨é€æ¶ˆæ¯æç¤º */
                if (response.status === true || response.status >= 200 && response.status < 300) {
                    await pushMsg(`NoteToCard: ${response.msg}`);
                    return null;
                }
                else {
                    await pushErrMsg(`NoteToCard: ${response.error || response.msg}`);
                    return null;
                }
            }
            else {
                switch ('') {
                    case config.server:
                        await pushErrMsg(`NoteToCard: æœåŠ¡ å­—æ®µä¸ºç©º`);
                        break;
                    case config.title:
                        await pushErrMsg(`NoteToCard: æ ‡é¢˜ å­—æ®µä¸ºç©º`);
                        break;
                    case config.markdown:
                        await pushErrMsg(`NoteToCard: markdown å­—æ®µä¸ºç©º`);
                        break;
                    case config.email:
                        await pushErrMsg(`NoteToCard: é‚®ç®± å­—æ®µä¸ºç©º`);
                        break;
                    case config.password:
                        await pushErrMsg(`NoteToCard: å¯†ç  å­—æ®µä¸ºç©º`);
                        break;
                    case config.handler:
                        await pushErrMsg(`NoteToCard: æ–¹æ³• å­—æ®µä¸ºç©º`);
                        break;
                }
                return;
            }
        }

        /* ç›‘å¬ markdown é¢„è§ˆæ–‡æœ¬æ¡†å†…å®¹æ›´æ”¹ */
        block_markdown.onchange = () => {
            if (block_markdown.value) {
                button_convert.disabled = false;
            }
            else {
                button_convert.disabled = true;
            }
        }
    })();
</script>

</html>
